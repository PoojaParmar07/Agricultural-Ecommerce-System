{% extends 'Ecommerce/base.html' %}
{% block content %}
{% load static %}
<title>Checkout - Jyoti Agro</title>
<link rel="stylesheet" href="{% static 'css/checkout_page.css' %}">
<div class="checkout-container">
    <!-- Billing Information -->
    <div class="billing-info">
        <h2>Billing Information</h2>
        <form id="checkout-form" action="{% url 'Ecommerce:checkout' %}" method="POST">
            {% csrf_token %}

            <label for="first-name">User Name</label>
            <input type="text" id="first-name" name="first_name" value="{{ request.user.username }}" required>

            <label for="address">Shipping Address</label>
            <input type="text" id="address" name="address" value="{{ request.user.profile.address }}" required>

            <div class="row">
                <div>
                    <label for="city">City</label>
                    <select id="city" name="city" required>
                        <option value="">Select City</option>
                        {% for city in cities %}
                            <option value="{{ city.city_id }}" >
                                {{ city.city_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                   
                    <label for="pincode">PinCode</label>
                    <select id="pincode" name="pincode" required>
                        <option value="">Select Pincode</option>
                        {% for pincode in pincodes %}
                            <option value="{{ pincode.area_pincode }}" >
                                {{ pincode.area_pincode }}
                            </option>
                        {% endfor %}
                    </select>
               
                </div>
            </div>

            <div class="row">
                <div>
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="{{ request.user.email }}" required>
                </div>
                <div>
                    <label for="phone">Phone</label>
                    <input type="text" id="phone" name="phone" value="{{ request.user.profile.mobile_number }}" required>
                </div>
            </div>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
        <h2>Order Summary</h2>
        <div class="items">
            {% for item in cart_items %}
            <div class="item">
                <img src="{{ item.product_variant.product.product_image.url }}" 
                alt="{{ item.product_variant.product.product_name }}" 
                class="cart-product-image">
                <div class="details">
                    <p>{{ item.product_variant.product.product_name }}</p>
                    <p>{{ item.product_variant.units }}</p>
                    <p>Qty : {{ item.quantity }}</p>
                    <span>₹{{ item.total_price }}</span>
                </div>
            </div>
            {% endfor %}
        </div> 
        
        <hr>
        <div class="summary-details">
            <p>Subtotal: ₹<span id="grand-total">{{ grand_total }}</span></p>
            <p>Discount: ₹<span class="free">{{ discount_amount }}</span></p>
            <p>Shipping: 
                <span id="shipping-charge">
                    {% if delivery_charge is not None %}₹{{ delivery_charge }}{% else %}0{% endif %}
                </span>
            </p>
            
            

            <p class="total">Total: <span><b>₹{{ final_total }}</b></span></p>
        </div>
        
        <h3>Payment Method</h3>
        <div class="payment-options">
            <label class="payment-option">
                <input type="radio" name="payment_method" value="COD" checked>
                <span class="custom-radio"></span> Cash on Delivery
            </label>
            <label class="payment-option">
                <input type="radio" name="payment_method" value="Online">
                <span class="custom-radio"></span> Online Payment
            </label>
        </div>
        
        <button type="submit" id="placeOrder" name="placeOrder">Place Order</button>
    </form>
    </div>
</div>

{% comment %} <script src="{% static 'js/script.js' %}"></script> {% endcomment %}
<script>
    document.getElementById('city').addEventListener('change', function() {
        let cityId = this.value;
        let pincodeDropdown = document.getElementById('pincode');
    
        if (cityId) {
            fetch("{% url 'Ecommerce:get_pincode' 0 %}".replace('0', cityId))  
            .then(response => response.json())
            .then(data => {
                pincodeDropdown.innerHTML = '<option value="">Select Pincode</option>';
                data.pincodes.forEach(pincode => {
                    let option = document.createElement("option");
                    option.value = pincode.area_pincode;
                    option.textContent = pincode.area_pincode;
                    pincodeDropdown.appendChild(option);
                });
            });
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        let form = document.getElementById("checkout-form");
        let placeOrderBtn = document.getElementById("placeOrder");

        placeOrderBtn.addEventListener("click", function (event) {
            event.preventDefault(); // Prevent default submission

            let selectedPaymentMethod = document.querySelector("input[name='payment_method']:checked").value;

            if (selectedPaymentMethod === "COD") {
                form.action = "{% url 'Ecommerce:cod_checkout' %}"; // COD view
            } else {
                form.action = "{% url 'Ecommerce:homepage' %}"; // Correct online payment view
            }

            form.submit(); // Submit form to the updated action URL
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        let shippingChargeSpan = document.getElementById("shipping-charge");
    
        if (!shippingChargeSpan) {
            console.error("❌ Element with ID 'shipping-charge' not found. Check your HTML.");
            return;
        }
    
        let pincodeDropdown = document.getElementById('pincode');
        if (pincodeDropdown) {
            pincodeDropdown.addEventListener('change', function () {
                let pincodeId = this.value;
                if (pincodeId) {
                    fetch("{% url 'Ecommerce:get_delivery_charge' 0 %}".replace('0', pincodeId))
                    .then(response => response.json())
                    .then(data => {
                        let deliveryCharge = parseFloat(data.delivery_charge) || 0;
                        shippingChargeSpan.textContent = deliveryCharge === 0 ? "Free" : "₹" + deliveryCharge.toFixed(2);
                        
                        let grandTotal = parseFloat(document.getElementById("grand-total").textContent) || 0;
                        let discountAmount = parseFloat(document.querySelector(".free").textContent) || 0;
                        let newTotal = grandTotal - discountAmount + deliveryCharge;
                        document.querySelector(".total span b").textContent = "₹" + newTotal.toFixed(2);
                    })
                    .catch(error => console.error("❌ Error fetching delivery charge:", error));
                }
            });
        } else {
            console.error("❌ Element with ID 'pincode' not found.");
        }
    });
    
    
     
    
</script>

{% endblock %}
