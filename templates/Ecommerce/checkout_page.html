{% extends 'Ecommerce/base.html' %}
{% block content %}
{% load static %}
<head>
<title>Checkout - Jyoti Agro</title>
<link rel="stylesheet" href="{% static 'css/checkout_page.css' %}">

</head>
<div class="checkout-container">
    <!-- Billing Information -->
    <div class="billing-info">
        <h2>Billing Information</h2>
        <form id="checkout-form" action="{% url 'Ecommerce:checkout' %}" method="POST">
            {% csrf_token %}

            <label for="first-name">User Name</label>
            <input type="text" id="first-name" name="first_name" value="{{ request.user.username }}" required>

            <label for="address">Shipping Address</label>
            <input type="text" id="address" name="address" value="{{ request.user.profile.address }}" required>

            <div class="row">
                <div>
                    <label for="city">City</label>
                    <select id="city" name="city" required>
                        <option value="">Select City</option>
                        {% for city in cities %}
                            <option value="{{ city.city_id }}" >
                                {{ city.city_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                   
                    <label for="pincode">PinCode</label>
                    <select id="pincode" name="pincode" required>
                        <option value="">Select Pincode</option>
                        {% for pincode in pincodes %}
                            <option value="{{ pincode.area_pincode }}" >
                                {{ pincode.area_pincode }}
                            </option>
                        {% endfor %}
                    </select>
               
                </div>
            </div>

            <div class="row">
                <div>
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="{{ request.user.email }}" required>
                </div>
                <div>
                    <label for="phone">Phone</label>
                    <input type="text" id="phone" name="phone" value="{{ request.user.profile.mobile_number }}" required>
                </div>
            </div>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
        <h2>Order Summary</h2>
        <div class="items">
            {% for item in cart_items %}
            <div class="item">
                <img src="{{ item.product_variant.product.product_image.url }}" 
                alt="{{ item.product_variant.product.product_name }}" 
                class="cart-product-image">
                <div class="details">
                    <p>{{ item.product_variant.product.product_name }}</p>
                    <p>{{ item.product_variant.units }}</p>
                    <p>Qty : {{ item.quantity }}</p>
                    <span>‚Çπ{{ item.total_price }}</span>
                </div>
            </div>
            {% endfor %}
        </div> 
        
        <hr>
        <div class="summary-details">
            <p>Subtotal: ‚Çπ<span id="grand-total">{{ grand_total }}</span></p>
            <p>Discount: ‚Çπ<span class="free">{{ discount_amount }}</span></p>
            <p>Shipping: 
                <span id="shipping-charge">
                    {% if delivery_charge is not None %}‚Çπ{{ delivery_charge }}{% else %}0{% endif %}
                </span>
            </p>
            
            

            <p class="total">Total: <span><b>‚Çπ{{ final_total }}</b></span></p>
        </div>
        
        <h3>Payment Method</h3>
        {% comment %} <div class="payment-options">
            <label class="payment-option">
                <input type="radio" name="payment_method" value="COD" checked>
                <span class="custom-radio"></span> Cash on Delivery
            </label>
            <label class="payment-option">
                <input type="radio" name="payment_method" value="Online">
                <span class="custom-radio"></span> Online Payment
            </label>
        </div> {% endcomment %}
        
        <div class="payment-options">
            <label class="payment-option">
                <input type="radio" name="payment_method" value="COD" id="payment_method_cod" checked>
                <span class="custom-radio"></span> Cash on Delivery
            </label>
            <label class="payment-option">
                <input type="radio" name="payment_method" value="Online" id="payment_method_online">
                <span class="custom-radio"></span> Online Payment
            </label>
        </div>
        
        
        <button id="rzp-button1">Pay Now</button>

    </form>
    </div>
</div>

{% comment %} <script src="{% static 'js/script.js' %}"></script> {% endcomment %}
{% comment %} 
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById("rzp-button1").addEventListener("click", function () {
        console.log("Button clicked! Initializing Razorpay...");
        
        var options = {
            "key": "{{ razorpay_key }}",  // Ensure this is passed correctly from views
            "amount": "{{ final_total }}",  // Amount in paisa (multiply by 100)
            "currency": "INR",
            "name": "Jyoti Agro",  // Change to your business name
            "description": "Purchase from Jyoti Agro",
            "order_id": "{{ razorpay_order_id }}",  // Razorpay Order ID
            "handler": function (response) {
                alert("Payment successful! Payment ID: " + response.razorpay_payment_id);
                window.location.href = "/payment/success/?payment_id=" + response.razorpay_payment_id;
            },
            "prefill": {
                "name": "{{ user.get_full_name }}",
                "email": "{{ user.email }}",
                "contact": "{{ user.profile.phone }}"
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        var rzp = new Razorpay(options);
        rzp.open();
    });
</script> {% endcomment %}








<script>
    document.getElementById('city').addEventListener('change', function() {
        let cityId = this.value;
        let pincodeDropdown = document.getElementById('pincode');
    
        if (cityId) {
            fetch("{% url 'Ecommerce:get_pincode' 0 %}".replace('0', cityId))  
            .then(response => response.json())
            .then(data => {
                pincodeDropdown.innerHTML = '<option value="">Select Pincode</option>';
                data.pincodes.forEach(pincode => {
                    let option = document.createElement("option");
                    option.value = pincode.area_pincode;
                    option.textContent = pincode.area_pincode;
                    pincodeDropdown.appendChild(option);
                });
            });
        }
    });

    {% comment %} document.addEventListener("DOMContentLoaded", function () {
        let form = document.getElementById("checkout-form");
        let placeOrderBtn = document.getElementById("placeOrder");

        placeOrderBtn.addEventListener("click", function (event) {
            event.preventDefault(); // Prevent default submission

            let selectedPaymentMethod = document.querySelector("input[name='payment_method']:checked").value;

            if (selectedPaymentMethod === "COD") {
                form.action = "{% url 'Ecommerce:cod_checkout' %}"; // COD view
            } else {
                form.action = "{% url 'Ecommerce:stripe_checkout' %}"; // Update to correct online payment view
            }

            form.submit(); // Submit form to the updated action URL
        });
    }); {% endcomment %}

    document.addEventListener("DOMContentLoaded", function () {
        let shippingChargeSpan = document.getElementById("shipping-charge");
    
        if (!shippingChargeSpan) {
            console.error("‚ùå Element with ID 'shipping-charge' not found. Check your HTML.");
            return;
        }
    
        let pincodeDropdown = document.getElementById('pincode');
        if (pincodeDropdown) {
            pincodeDropdown.addEventListener('change', function () {
                let pincodeId = this.value;
                if (pincodeId) {
                    fetch(`/get-delivery-charge/${pincodeId}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("üöÄ API Response:", data);  // Debugging
    
                        let deliveryCharge = parseFloat(data.delivery_charge) || 0;
                        shippingChargeSpan.textContent = deliveryCharge === 0 ? "Free" : "‚Çπ" + deliveryCharge.toFixed(2);
    
                        let grandTotal = parseFloat(document.getElementById("grand-total").textContent) || 0;
                        let discountAmount = parseFloat(document.querySelector(".free").textContent) || 0;
                        let newTotal = grandTotal - discountAmount + deliveryCharge;
    
                        document.querySelector(".total span b").textContent = "‚Çπ" + newTotal.toFixed(2);
                    })
                    .catch(error => console.error("‚ùå Error fetching delivery charge:", error));
                }
            });
        } else {
            console.error("‚ùå Element with ID 'pincode' not found.");
        }
    });
    
    
    document.addEventListener("DOMContentLoaded", function () {
        let form = document.getElementById("checkout-form");
        let placeOrderBtn = document.getElementById("rzp-button1");

        placeOrderBtn.addEventListener("click", function (event) {
            console.log("Button clicked! Initializing Razorpay...");
            event.preventDefault(); // Prevent default form submission

            let selectedPaymentMethod = document.querySelector("input[name='payment_method']:checked").value;

            if (selectedPaymentMethod === "COD") {
                form.action = "{% url 'payment:cod_checkout' %}"; // COD view
            } else {
                form.action = "{% url 'payment:razorpay_checkout' %}"; // Stripe payment view 
            }

            // ‚úÖ Ensure variant_id is included in the request
            let variantIdInput = document.createElement("input");
            variantIdInput.type = "hidden";
            variantIdInput.name = "variant_id";
            variantIdInput.value = "{{ cart_items.0.product_variant.variant_id }}";  // Assuming first item in cart
            form.appendChild(variantIdInput);

            form.submit(); // Submit form after updating action URL
        });
    });
    
</script>

{% endblock %}
